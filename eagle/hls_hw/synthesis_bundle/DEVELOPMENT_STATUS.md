# Deep Pipeline LUT-MAC – Design & Status

## Design Snapshot
- **tmac_utils.hpp**: Single source for host/HLS shims (`hls::stream`, `hls::vector`, math wrappers) plus shared aliases `vec_t`, `hls_stream`, `pack512`, `VEC_W=16`.
- **dense_projection** (`deep_pipeline_lutmac.hpp`): Broadcast-packed int4 weights, interleaved accumulators (4 banks) to hide FP add latency, optional LUT-MAC vs DSP path (`ENABLE_TMAC`). Scaled variant consumes per-group scales.
- **attention_solver.hpp**: Online softmax with 4-way partial score accumulation to achieve II=1; stationary Q buffer; streams K/V history; outputs normalized context.
- **kv_cache_manager.hpp**: Hot-tier URAM (16K tokens) + cold-tier HBM, loop fission for deterministic hot path and bursty cold path. AXIS in/out for K/V.
- **rms_norm_stream.hpp**: Streaming RMSNorm with buffered sum-of-squares and gamma apply.
- **rope_kernel.hpp**: Buffered RoPE applying host-provided cos/sin per position; vec16 streams for Q/K.
- **stream_utils.hpp**: Stream plumbing (dup/trip/add/scale/SwiGLU SiLU*up).
- **eagle_tier1_top.hpp**: Dataflow skeleton for one token through Norm → Q/K/V proj → RoPE → KV cache → attention (single head placeholder) → O proj → residual → Norm2 → FFN (gate/up, SiLU*up, down) → residual. Uses packed weights/scales; still single-head attention.
- **test_eagle_top.cpp**: End-to-end host harness for Tier1. Supports `--smoke` (self-contained deterministic check) and `--list-required-goldens` (explicit tensor checklist), plus full golden comparison when external tensors are available.
- **deep_pipeline_lutmac_tb.cpp / fc1_compare_tb.cpp**: Host testbenches; `--smoke` path is self-contained, FC1 comparison exercises packed-bin ingest (`weights_swizzled.bin` / `scales_swizzled.bin`).

## Current Status
- **Build**: Host compile clean (`g++ -std=c++17 -I. hls/export_tilert_gemm/deep_pipeline_lutmac/deep_pipeline_lutmac_tb.cpp -o /tmp/deep_pipeline_lutmac_tb`).
- **Tests**: `./tmp/deep_pipeline_lutmac_tb --smoke` passes (self-contained broadcast GEMM check). FC1 tile test requires `weights_swizzled.bin`/`scales_swizzled.bin` generated by `pack_fc1.py`.
- **Top-level**: `eagle_tier1_top` includes grouped-query multi-head attention path with selectable solver (`attention_solver` or `fused_online_attention_pwl`) and TMAC projection toggles.

## Next Steps
1) Extend attention to iterate all heads (Q split per head; reuse K/V history streams).
2) Add testbench for `eagle_tier1_top` with packed weights/scales to match `eagle_verified_all_4bit.cpp` intermediates.
3) Wire HBM connectivity (weights vs cold KV) in link cfg; optional multi-bank spread.
4) Enable RoPE host precompute path in tests and add regression to compare against CPU reference.

## File-by-File Detail
- `tmac_utils.hpp`: Consolidated host/HLS shims. Provides `hls::stream` with label ctor for C-sim, `hls::vector` (std::array wrapper in host), math wrappers, `pack512`, and shared aliases `vec_t`, `hls_stream`, `VEC_W`. Goal: one source of truth for types across kernels; remove duplicate fallbacks elsewhere.
- `deep_pipeline_lutmac.hpp`: Core int4 broadcast GEMM. Helpers `get_w4_raw`/`decode_w4`; LUT-MAC tile and broadcast variants; interleaved accumulators (4 banks) to hide FP add latency; scaled variants for per-group scales; template toggle `ENABLE_TMAC` for LUT vs DSP. Used by all projections (Q/K/V/O/gate/up/down); AXIS in, packed vec16 payloads.
- `attention_solver.hpp`: Streaming single-head attention with online softmax. Stationary Q buffer; streams K/V; 4-way partial score accumulation to maintain II=1; softmax rescaling (m_prev/d_prev); outputs normalized context. Uses shared vec/stream types via utils.
- `kv_cache_manager.hpp`: Hybrid KV cache. URAM hot tier (16K tokens) with deterministic II=1 read/write; HBM cold tier with burst access. Loop fission separates hot and cold paths to avoid latency-dependent stalls. AXIS interfaces for K/V streams; AXI-MM for HBM spill.
- `rms_norm_stream.hpp`: Streaming RMSNorm. Buffers one token, computes sum of squares, applies gamma/eps, and streams normalized output. Keeps II=1 on vec16 lane pairs.
- `rope_kernel.hpp`: Buffered rotary embedding. Host supplies cos/sin for current position; loads full head into BRAM, rotates pairs (i, i+HEAD_DIM/2), streams Q/K out as vec16. Avoids runtime sin/cos; assumes precomputed coefficients.
- `stream_utils.hpp`: Dataflow plumbing helpers (scale, dup, trip, add, SiLU*up for SwiGLU). All operate on `hls_stream<vec_t<W>>` with II=1 pipelines and optional depth attributes; used for residual splits and activations.
- `eagle_tier1_top.hpp`: Dataflow token path through RMSNorm -> Q/K/V proj -> RoPE -> KV cache -> grouped-query attention -> O proj -> residual -> Norm2 -> gate/up -> SiLU*up -> down proj -> final residual, with compile-time switches for attention solver and TMAC projection path.
- `deep_pipeline_lutmac_tb.cpp`: Host testbench. `--smoke` self-contained int4 GEMM check (pass). FC1 tile test expects `weights_swizzled.bin`/`scales_swizzled.bin`. Uses `dense_projection_production` APIs and compares against a CPU reference; good for regression in CI.
- `fc1_compare_tb.cpp`: Comparison harness for FC1 tiles using packed weights/scales (similar dependencies on swizzled bins); focuses on correctness vs CPU decode.
- `weights_swizzled.bin`, `scales_swizzled.bin`: Packed weight/scale dumps produced by pack scripts; required for FC1/FC2-style tests. Not versioned; regenerate with packers when weights change.
- `test_eagle_top.cpp`: Runtime verification harness. Full mode compares against captured goldens, `--smoke` runs without external tensors, and dimension checks fail fast when packed weight bundles do not match compile-time constants.
