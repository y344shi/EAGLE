<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
  <style>
    .title { font: bold 24px sans-serif; }
    .subtitle { font: bold 18px sans-serif; }
    .label { font: 14px sans-serif; }
    .small { font: 12px sans-serif; }
    .box { fill: #f0f0f0; stroke: #333; stroke-width: 2; }
    .highlight { fill: #d0e0ff; }
    .process { fill: #ffe0d0; }
    .data { fill: #d0ffe0; }
    .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    .dashed { stroke-dasharray: 5,5; }
  </style>
  
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="400" y="30" class="title" text-anchor="middle">Triton Fused Drafter Architecture</text>
  
  <!-- Input Section -->
  <rect x="50" y="70" width="700" height="80" class="box data" rx="5" ry="5" />
  <text x="400" y="95" class="subtitle" text-anchor="middle">Inputs</text>
  
  <rect x="70" y="110" width="150" height="30" class="box" rx="3" ry="3" />
  <text x="145" y="130" class="label" text-anchor="middle">Concatenated Taps</text>
  
  <rect x="240" y="110" width="150" height="30" class="box" rx="3" ry="3" />
  <text x="315" y="130" class="label" text-anchor="middle">EA Layer Params</text>
  
  <rect x="410" y="110" width="150" height="30" class="box" rx="3" ry="3" />
  <text x="485" y="130" class="label" text-anchor="middle">LM Head Weights</text>
  
  <rect x="580" y="110" width="150" height="30" class="box" rx="3" ry="3" />
  <text x="655" y="130" class="label" text-anchor="middle">Tree Metadata</text>
  
  <!-- Persistent Kernel -->
  <rect x="50" y="180" width="700" height="300" class="box highlight" rx="5" ry="5" />
  <text x="400" y="205" class="subtitle" text-anchor="middle">Persistent Triton Kernel (One PI per sequence)</text>
  
  <!-- Pipeline Steps -->
  <rect x="70" y="230" width="660" height="230" class="box process" rx="5" ry="5" />
  <text x="400" y="250" class="subtitle" text-anchor="middle">7-Step Pipeline (per depth)</text>
  
  <!-- Step 1 -->
  <rect x="90" y="270" width="180" height="40" class="box" rx="3" ry="3" />
  <text x="180" y="295" class="label" text-anchor="middle">1. Feature Ingest + Align</text>
  
  <!-- Step 2 -->
  <rect x="90" y="320" width="180" height="40" class="box" rx="3" ry="3" />
  <text x="180" y="345" class="label" text-anchor="middle">2. QKV + ROPE + Cache Write</text>
  
  <!-- Step 3 -->
  <rect x="90" y="370" width="180" height="40" class="box" rx="3" ry="3" />
  <text x="180" y="395" class="label" text-anchor="middle">3. Tree Attention</text>
  
  <!-- Step 4 -->
  <rect x="90" y="420" width="180" height="30" class="box" rx="3" ry="3" />
  <text x="180" y="440" class="label" text-anchor="middle">4. RMSNorm + MLP</text>
  
  <!-- Step 5 -->
  <rect x="290" y="270" width="200" height="40" class="box" rx="3" ry="3" />
  <text x="390" y="295" class="label" text-anchor="middle">5. LM-head + Streaming Top-K</text>
  
  <!-- Step 6 -->
  <rect x="290" y="320" width="200" height="40" class="box" rx="3" ry="3" />
  <text x="390" y="345" class="label" text-anchor="middle">6. Global K-way Prune</text>
  
  <!-- Step 7 -->
  <rect x="290" y="370" width="200" height="40" class="box" rx="3" ry="3" />
  <text x="390" y="395" class="label" text-anchor="middle">7. Advance State</text>
  
  <!-- Memory Buffers -->
  <rect x="510" y="270" width="200" height="190" class="box data" rx="3" ry="3" />
  <text x="610" y="290" class="label" text-anchor="middle">Memory Buffers</text>
  
  <text x="520" y="315" class="small">• K/V Cache</text>
  <text x="520" y="335" class="small">• Position IDs</text>
  <text x="520" y="355" class="small">• Parents</text>
  <text x="520" y="375" class="small">• Frontier Indices</text>
  <text x="520" y="395" class="small">• Scores</text>
  <text x="520" y="415" class="small">• Candidate Tokens/Scores</text>
  <text x="520" y="435" class="small">• Next Frontier</text>
  
  <!-- Output Section -->
  <rect x="50" y="510" width="700" height="70" class="box data" rx="5" ry="5" />
  <text x="400" y="535" class="subtitle" text-anchor="middle">Outputs</text>
  
  <rect x="70" y="545" width="150" height="25" class="box" rx="3" ry="3" />
  <text x="145" y="562" class="label" text-anchor="middle">draft_tokens</text>
  
  <rect x="240" y="545" width="150" height="25" class="box" rx="3" ry="3" />
  <text x="315" y="562" class="label" text-anchor="middle">retrieve_indices</text>
  
  <rect x="410" y="545" width="150" height="25" class="box" rx="3" ry="3" />
  <text x="485" y="562" class="label" text-anchor="middle">tree_mask</text>
  
  <rect x="580" y="545" width="150" height="25" class="box" rx="3" ry="3" />
  <text x="655" y="562" class="label" text-anchor="middle">tree_position_ids</text>
  
  <!-- Arrows -->
  <path d="M400,150 L400,180" class="arrow" />
  <path d="M400,480 L400,510" class="arrow" />
  
  <!-- Depth Loop -->
  <path d="M730,300 C760,300 760,380 730,380" class="arrow dashed" />
  <text x="760" y="340" class="label" text-anchor="middle" transform="rotate(90,760,340)">Depth Loop</text>
</svg>